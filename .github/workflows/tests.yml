name: GitHub Actions CI
on:
  push:
    branches:
      - master
  pull_request:
jobs:
  tests:
    strategy:
      matrix:
        os:
          - macOS-latest
          - ubuntu-latest
          - windows-latest
        include:
          - os: macOS-latest
            shell: bash
          - os: ubuntu-latest
            shell: bash
          - os: windows-latest
            shell: "wsl-bash {0}"
    runs-on: ${{matrix.os}}
    defaults:
      run:
        shell: ${{ matrix.shell }}
    steps:
      - name: Set up WSL
        if: runner.os == 'windows'
        shell: powershell
        run: |
          git config --global core.autocrlf false
          git config --global core.eol lf
          echo "/home/linuxbrew/.linuxbrew/bin:/usr/bin:/bin" >> ${GITHUB_PATH}

      - name: Set up Git repository
        uses: actions/checkout@main

      - name: Cleanup macOS
        if: runner.os == 'macOS'
        run: |
          sudo rm -rf /Applications/Xcode.app \
                      /Library/Developer/CommandLineTools
          sudo xcode-select --reset

      - name: Install WSL
        if: runner.os == 'windows'
        # https://github.com/Vampire/setup-wsl/releases/tag/v1.0.1
        uses: Vampire/setup-wsl@bb4708da2512aac2a4c2947effc1061ecc0a9aef
        with:
          distribution: Ubuntu-16.04
          wsl-shell-command: 'bash -c "sudo -u runner bash --noprofile --norc -euo pipefail "\'

      - name: Set up WSL users
        if: runner.os == 'windows'
        shell: wsl-bash {0}
        run: |
          adduser runner --disabled-password --gecos ""

      - name: Set up Homebrew PATH
        run: |
          if [ "${RUNNER_OS}" = "macOS" ]; then
            echo "/usr/local/bin:/usr/bin:/bin" >> ${GITHUB_PATH}
          else
            echo "/home/linuxbrew/.linuxbrew/bin:/usr/bin:/bin" >> ${GITHUB_PATH}
          fi

      - name: Uninstall GitHub Actions Homebrew
        run: |
          if which brew &>/dev/null; then
            /bin/bash uninstall.sh -d >/dev/null
            /bin/bash uninstall.sh -f >/dev/null
          fi

      - run: /bin/bash -c "$(cat install.sh)"

      - run: brew install ack

      - run: /bin/bash uninstall.sh -f >/dev/null

      - run: /bin/bash -c "$(cat install.sh)"

      - name: Uninstall and reinstall with sudo NOPASSWD
        if: runner.os == 'linux'
        run: |
          echo "$USER ALL=(ALL) NOPASSWD:ALL" | sudo tee "/etc/sudoers.d/$USER"
          /bin/bash uninstall.sh -f >/dev/null
          /bin/bash -c "$(cat install.sh)"

      - run: brew install shellcheck

      - run: shellcheck *.sh

      - run: /bin/bash uninstall.sh -d >/dev/null

      - run: /bin/bash uninstall.sh -f >/dev/null
